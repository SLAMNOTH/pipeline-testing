trigger:
- none

variables:
  resourceGroupName: 'winvm-rg'
  location: 'westeurope'
  templateFile: './main.bicep'
  adminUN: 'azureuser' # Or use a pipeline variable
  # adminPASS should be set as a secret pipeline variable

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self

- task: AzureCLI@2
  displayName: 'Deploy Windows VM with Bicep'
  inputs:
    azureSubscription: 'azure-connection'
    scriptType: bash
    scriptLocation: inlineScript
    useGlobalConfig: false
    inlineScript: |
      az --version
      az group create --name $(resourceGroupName) --location $(location)
      az deployment group create \
        --resource-group $(resourceGroupName) \
        --template-file $(templateFile) \
        --parameters adminUsername="$(adminUN)" adminPassword="$(adminPASS)"